<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Heatmaps</title>
    <link rel="stylesheet" href="static/stylesheet.css">
  </head>
  <body>
    <div id="floating-panel">
      <div class="group">
          <div class="subject">Radius <span id=radiusNum>10</span></div>
          <button onclick="changeRadius(true)">Up</button>
          <button onclick="changeRadius(false)">Down</button>
      </div>
      <div class="group">
          <div class="subject">Intensity <span id=intensityNum>0</span></div>
          <button onclick="changeIntensity(true)">Up</button>
          <button onclick="changeIntensity(false)">Down</button>
      </div>
      <div class="group">
          <div class="subject">Opacity <span id=opacityNum>.6</span></div>
          <button onclick="changeOpacity(true)">Up</button>
          <button onclick="changeOpacity(false)">Down</button>
      </div>
    </div>
    <h1 style="margin-left:1%;">Welcome to My Heat Map</h1>
    <div id="map-container">
      <div id="map"></div>
      <div id="toggles">
        <h3>Toggle:</h3>
        <button id="shops" style="font-size:25px;">Evictions</button>
        <br>
        <br>
        <div id="bike-buttons">
          <button id="bike" style="font-size:25px;">Citi Bike Stations: OFF</button>
        </div>
        <br>
        <br>
        <button id="noise" style="font-size:25px;">Noise Complaints: OFF</button>
      </div>
    </div>
    <div id="comments">
      <h4>Here is the comments area!</h4>
      <ul>
        <li>This is cool!</li>
        <br>
        <li>Nice map!</li>
      </ul>
    </div>

    <script>
      const maxI = 0, rad = 10, opac = .6;
      let map, bikeHeatMap, noiseHeatMap;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: {lat: 40.759917, lng: -73.897947},
          mapTypeId: 'roadmap'
        });
        const bikeButton = document.getElementById("bike")
        bikeButton.addEventListener('click', addBikeHeatMap)

        const noiseButton = document.getElementById("noise")
        noiseButton.addEventListener('click', addNoiseHeatMap)
      }

      function addBikeHeatMap(event) {
        const bikeButton = document.getElementById("bike")
        const bikeDiv = document.getElementById("bike-buttons")
        const yearButton2014 = document.createElement("button")
        yearButton2014.innerText = "2014"
        yearButton2014.style.display = "none"
        yearButton2014.id = "bike-2014"
        const yearButton2018 = document.createElement("button")
        yearButton2018.innerText = "2018"
        yearButton2018.style.display = "none"
        yearButton2018.id = "bike-2018"
        bikeDiv.appendChild(yearButton2014)
        bikeDiv.appendChild(yearButton2018)
          if (event.target.innerText === "Citi Bike Stations: OFF") {
            fetch('static/citi_bikes2014.json')
            .then(res => res.json())
            .then(result => {
              let locations = result.stationBeanList.map((val) => {
                return new google.maps.LatLng(val.latitude, val.longitude);
              })
              bikeHeatMap = new google.maps.visualization.HeatmapLayer({
                data: locations,
                map: map,
                maxIntensity: maxI,
                radius: rad,
                opacity: opac
              })
            })
            bikeButton.innerText = "Citi Bike Stations: ON"
            const button2014 = document.getElementById("bike-2014")
            button2014.style.display = "block"
            const button2018 = document.getElementById("bike-2018")
            button2018.style.display = "inline-flex"
          } else if (event.target.innerText === "Citi Bike Stations: ON") {
            const theBut14 = document.getElementById("bike-2014")
            const theBut18 = document.getElementById("bike-2018")
            bikeHeatMap = bikeHeatMap.setMap(null)
            bikeButton.innerText = "Citi Bike Stations: OFF"
            theBut14.style.display = "none"
            theBut18.style.display = "none"
          }
        }

        const theBut14 = document.getElementById("bike-2014")
        theBut14.addEventListener('click', event => {
          fetch('static/citi_bikes2014.json')
          .then(res => res.json())
          .then(result => {
            let locations = result.stationBeanList.map((val) => {
              return new google.maps.LatLng(val.latitude, val.longitude);
            })
            bikeHeatMap = new google.maps.visualization.HeatmapLayer({
              data: locations,
              map: map,
              maxIntensity: maxI,
              radius: rad,
              opacity: opac
            })
          })
        });

        function addNoiseHeatMap(event) {
          const noiseButton = document.getElementById("noise")
            if (event.target.innerText === "Noise Complaints: OFF") {
              fetch('static/noise2010.json')
              .then(res => res.json())
              .then(result => {
                let locations = result.map((val) => {
                  return new google.maps.LatLng(val.Latitude, val.Longitude);
                })
                noiseHeatMap = new google.maps.visualization.HeatmapLayer({
                  data: locations,
                  map: map,
                  maxIntensity: maxI,
                  radius: rad,
                  opacity: opac
                })
              })
              noiseButton.innerText = "Noise Complaints: ON"
            } else if (event.target.innerText === "Noise Complaints: ON") {
              noiseHeatMap = noiseHeatMap.setMap(null)
              noiseButton.innerText = "Noise Complaints: OFF"
            }
          }

      // Function to change the radius of data points on heatmap
      function changeRadius(bool) {
        const step = 2, min = 0, max = 50;
        let current = heatmap.get('radius');
        let newValue = toggleUpDown(bool, current, step, min, max);

        heatmap.set('radius', newValue);
        document.getElementById("radiusNum").innerText = newValue;
      };

      // Function to change the opacity of the heatmap
      function changeOpacity(bool) {
        const step = .2, min = 0, max = 1;
        let current = heatmap.get('opacity');
        let newValue = toggleUpDown(bool, current, step, min, max);
        let rounded = round(newValue, 1);

        heatmap.set('opacity', rounded);
        document.getElementById("opacityNum").innerText = rounded;
      }

      // Function to change maxIntensity of the heatmap
      function changeIntensity(bool) {
        const step = 10, min = 0, max = 1000;
        let current = heatmap.get('maxIntensity');
        let newValue = toggleUpDown(bool, current, step, min, max);

        heatmap.set('maxIntensity', newValue);
        document.getElementById("intensityNum").innerText = newValue;
      };

      // Changes our toggle values and keeps them within our min/max values
      function toggleUpDown(bool, current, step, min, max){
        if (bool && current >= max) return current;
        if (!bool && current <= min) return current;

        if (bool) return current + step;
        return current - step;
      }

      // Used to round the opacity toggle to one decimal place
      function round(value, precision) {
        var multiplier = Math.pow(10, precision || 0);
        return Math.round(value * multiplier) / multiplier;
      }

    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAelUr6kBl9WauSQGBbp2lTeT63DWZT-AA&libraries=visualization&callback=initMap">
    </script>
  </body>
</html>
